#!/bin/bash
# Minimal bashrc for testing

# Set HOME if missing
[ -z "$HOME" ] && export HOME="/home/mhugo"

# Use a user-writable npm global prefix to avoid sudo
export NPM_CONFIG_PREFIX="$HOME/.npm-global"

# Set PATH properly - system paths first, then user paths
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Add user paths first (before tool managers)
export PATH="$HOME/.local/bin:$HOME/.npm-global/bin:$HOME/.cargo/bin:$HOME/.amp/bin:$PATH"

# Activate mise (installed to ~/.local/bin/mise)
if [ -f "$HOME/.local/bin/mise" ]; then
  eval "$("$HOME/.local/bin/mise" activate bash)"
fi

# Add Nix to PATH AFTER mise (critical for direnv to work)
if [ -e /nix/var/nix/profiles/default/bin ]; then
  export PATH="/nix/var/nix/profiles/default/bin:$PATH"
fi
if [ -e "$HOME/.nix-profile/bin" ]; then
  export PATH="$HOME/.nix-profile/bin:$PATH"
fi

# Load Nix environment (sets NIX_PROFILES and other env vars)
if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
elif [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

# Activate direnv (needed for both interactive and non-interactive shells for VSCode)
if command -v direnv > /dev/null 2>&1; then
  eval "$(direnv hook bash)"
fi

# Interactive shell setup (only for interactive shells)
if [[ $- == *i* ]]; then
  # Starship prompt (installed via mise)
  if command -v starship > /dev/null 2>&1; then
    eval "$(starship init bash)"
  else
    # Nice fallback prompt with git branch support
    parse_git_branch() {
      git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
    }
    PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[33m\]$(parse_git_branch)\[\033[00m\]\$ '
  fi
fi
